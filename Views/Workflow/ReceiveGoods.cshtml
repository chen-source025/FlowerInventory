@model FlowerInventory.Models.Batch

@{
    ViewData["Title"] = "進貨作業";
}

<div class="container">
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card shadow">
                <div class="card-header bg-success text-white">
                    <h4><i class="fas fa-truck-loading"></i> 進貨作業</h4>
                </div>
                <div class="card-body">
                    <form asp-action="ReceiveGoods">
                        <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                        
                        <div class="mb-3">
                            <label asp-for="FlowerId" class="form-label">選擇花卉</label>
                            <select asp-for="FlowerId" class="form-select" asp-items="ViewBag.Flowers">
                                <option value="">-- 請選擇花卉 --</option>
                            </select>
                            <span asp-validation-for="FlowerId" class="text-danger"></span>
                        </div>
                        
                        <div class="mb-3">
                            <label asp-for="BatchNo" class="form-label">批號</label>
                            <input asp-for="BatchNo" class="form-control" placeholder="留空將自動產生" />
                            <span asp-validation-for="BatchNo" class="text-danger"></span>
                            <small class="form-text text-muted">建議格式: 花卉代碼+日期，如: R20240101</small>
                        </div>
                        
                        <div class="mb-3">
                            <label asp-for="QuantityReceived" class="form-label">進貨數量</label>
                            <input asp-for="QuantityReceived" class="form-control" 
                                min="1" max="10000"
                                onchange="calculateExpiryDate()" />
                            <span asp-validation-for="QuantityReceived" class="text-danger"></span>
                            <small class="form-text text-muted">範圍: 1 - 10,000</small>
                        </div>
                        
                        <div class="mb-3">
                            <label asp-for="ReceivedDate" class="form-label">收貨日期</label>
                            <input asp-for="ReceivedDate" class="form-control" type="date" />
                            <span asp-validation-for="ReceivedDate" class="text-danger"></span>
                        </div>
                        
                        <div class="mb-3">
                            <label asp-for="ExpiryDate" class="form-label">到期日</label>
                            <input asp-for="ExpiryDate" class="form-control" type="date" 
                                id="expiryDate" readonly />
                            <small class="form-text text-muted">根據花卉保存天數自動計算</small>
                        </div>

                        <div class="alert alert-info">
                            <h6><i class="fas fa-info-circle"></i> 作業流程說明</h6>
                            <p class="mb-0">
                                <strong>進貨 → 品檢 → 庫存(+) → 出貨 → 庫存(-) → 比對安全庫存 → 提出建議</strong><br>
                                完成進貨後，系統將引導您進行品檢作業，確認實際可入庫數量。
                            </p>
                        </div>
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save"></i> 儲存並進行品檢
                            </button>
                            <a href="@Url.Action("Dashboard")" class="btn btn-secondary">取消</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts
{
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}

    <script>
        function calculateExpiryDate() 
        {
            const flowerSelect = document.getElementById('FlowerId');
            const receivedDateInput = document.getElementById('ReceivedDate');
            const expiryDate = document.getElementById('expiryDate');

            if(flowerSelect.value && receivedDate.value)
            {
                // 呼叫 API 取得花卉保存天數並計算到期天數
                const received = new Date(receivedDate.value);
                received.setDate(received.getDate() + 30); // 預設30天
                expiryDate.value = received.toISOString().split('T')[0];
            }
        }

        document.getElementById('FlowerId').addEventListener('change', calculateExpiryDate);
        document.getElementById('ReceivedDate').addEventListener('change', calculateExpiryDate);

        // 頁面載入時計算一次
        document.addEventListener('DOMContentLoaded', calculateExpiryDate);
    </script>
}
